<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Методика организации работы блока реализации и развития услуг</title>
  <script src="js/navigation-maps.js"></script>
  <style>
  /* ======= Design tokens (тёмно-синий + белый) ======= */
  :root{
    --brand:#0f1f3d;        /* тёмно-синий */
    --brand-600:#0b1730;
    --brand-700:#081125;
    --accent:#1e40af;       /* насыщенный синий */
    --bg:#f7f9fc;           /* белый фон */
    --text:#0b1220;
    --muted:#6b7280;
    --surface:#ffffff;
    --surface-2:#f2f5fb;
    --border:#e6eaf2;
    --shadow-sm:0 4px 12px rgba(15,31,61,.06);
    --shadow-md:0 10px 28px rgba(15,31,61,.10);
    --shadow-lg:0 18px 50px rgba(15,31,61,.18);
    --radius:16px;
    --light-blue:#eaf2ff;
    --light-blue-2:#f4f8ff;
    /* Положение плашки Digital относительно РЕГЛАМЕНТ */
    
  }

  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%}

  body{
    font-family:Inter, -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,system-ui,sans-serif;
    background: radial-gradient(1200px 700px at -10% -20%, rgba(30,64,175,.08), transparent 60%),
                radial-gradient(1200px 700px at 110% -10%, rgba(15,31,61,.10), transparent 60%),
                var(--bg);
    color:var(--text);
    line-height:1.55;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* ======= Header: сетка 2 колонки ======= */
  .header{
    position:sticky; top:0; z-index:50;
    padding:.8rem 2rem 1rem; /* немного подняли верх */
    border-bottom:1px solid rgba(255,255,255,.12);
    color:#fff;
    background: linear-gradient(180deg, rgba(8,17,37,.55), rgba(8,17,37,.35)),
                radial-gradient(1000px 300px at 20% -40%, rgba(30,64,175,.35), transparent 60%),
                linear-gradient(135deg, var(--brand), #1b2d59);
    backdrop-filter:saturate(1.15) blur(8px);
    box-shadow: var(--shadow-sm);
    overflow:hidden;

    display:grid;
    grid-template-columns: minmax(320px,1fr) minmax(360px,520px);
    column-gap:2cm;           /* отступ ~2 см до формы справа */
    align-items:start;        /* выравниваем по верхнему краю */
  }
  /* фоновые частицы */
  .header::before,
  .header::after{ content:""; position:absolute; inset:-50%; pointer-events:none; filter:blur(40px);
    background: conic-gradient(from 0deg, rgba(15,31,61,.25), rgba(255,255,255,.18), rgba(15,31,61,.25));
    animation: spin 30s linear infinite; opacity:.28; transform: translateZ(0);
  }
  .header::after{ animation-direction: reverse; opacity:.2 }
  @keyframes spin{ to{ transform: rotate(360deg) } }

  /* Левая колонка: РЕГЛАМЕНТ + Digital (вплотную), под ним РОССЕТИ КУБАНЬ */
  .header-bar{ position:relative; z-index:1; display:flex; flex-direction:column; align-items:flex-start; gap:.25rem; margin:0; margin-top:-.05rem }
  .title-left{ display:flex; align-items:flex-end; gap:0 }
  .brand-title{ font-weight:900; letter-spacing:.6px; font-size:1.9rem; text-transform:uppercase; line-height:1; text-shadow:0 1px 0 rgba(0,0,0,.2) }
  
    padding:.15rem .6rem; border-radius:999px; line-height:1.1; font-weight:700; letter-spacing:.3px;
    background:rgba(255,255,255,.20); border:1px solid rgba(255,255,255,.38); color:#eaf2ff; box-shadow: inset 0 1px 0 rgba(255,255,255,.25)
  }
  /* Переливающаяся надпись: тёмно-синий ↔ ярко-белый */
  .title-right{
    text-transform:uppercase; font-weight:900; letter-spacing:.6px; font-size:1.9rem; line-height:1; text-shadow:0 1px 0 rgba(0,0,0,.2);
    background: linear-gradient(90deg, #0f1f3d, #ffffff, #0f1f3d);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    background-size:200% auto; animation: rightShine 6s linear infinite; /* плавное переливание */
    margin-top:.02rem; /* почти вплотную к РЕГЛАМЕНТ */
  }
  @keyframes rightShine{ from{ background-position: -100% 0 } to{ background-position: 200% 0 } }
  @media (prefers-reduced-motion: reduce){ .title-right{ animation:none } }

  /* Правая колонка: селект + поиск столбцом (пододвинули ближе) */
  .controls{ position:relative; z-index:1; display:flex; flex-direction:column; gap:.5rem; align-items:stretch }

  /* Строгие монотонные формы: без подсветок и без «дёрганий» */
  select, input[type="text"]{
    appearance:none; padding:.5rem .8rem; border:1px solid rgba(255,255,255,.18);
    border-radius:12px; font-size:.92rem; color:#e5edff; background:rgba(255,255,255,.06);
    box-shadow:none; width:100%; transition: background-color .15s ease, border-color .15s ease; /* без transform */
  }
  /* убрали подсвеченный ободок и изменение цвета на фокус */
  select:focus, input[type="text"]:focus{ outline:none; border-color:rgba(255,255,255,.18); background:rgba(255,255,255,.06); box-shadow:none }
  select:hover, input[type="text"]:hover{ border-color:rgba(255,255,255,.24) }

  select{ min-width:280px; cursor:pointer;
    background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23c7d2fe'><path d='M4 6l4 4 4-4z'/></svg>");
    background-repeat:no-repeat; background-position:right .6rem center; background-size:16px; padding-right:2rem; }

  .search-wrap{ position:relative }
  #searchInput{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23c7d2fe' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='11' cy='11' r='8'/><line x1='21' y1='21' x2='16.65' y2='16.65'/></svg>"); background-repeat:no-repeat; background-position:.6rem center; padding-left:2.2rem; padding-right:2.2rem }
  #clearSearch{ position:absolute; top:50%; right:.35rem; transform:translateY(-50%); border:none; background:transparent; color:#c7d2fe; width:28px; height:28px; border-radius:8px; cursor:pointer; font-size:1.15rem; line-height:1; display:none }
  #clearSearch:hover{ color:#ffffff }
  ::placeholder{ color:#c7d2fe }

  /* ======= Контент ======= */
  .container{ max-width:1200px; margin:1.1rem auto; padding:0 1.25rem }

  .section-card{ background:var(--surface); border:1px solid var(--border); border-radius:14px; margin-bottom:.85rem; box-shadow:var(--shadow-sm); transition: box-shadow .2s ease, border-color .2s ease }
  .section-card:hover{ box-shadow:var(--shadow-md); border-color:#d8e0ee }

  /* Узкие «формы» заголовков + серая полоска сверху */
  .section-header{ position:relative; padding:.56rem .85rem; background:linear-gradient(180deg, var(--light-blue-2), var(--surface));
    cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:1rem; border-bottom:1px solid var(--border); border-top-left-radius:14px; border-top-right-radius:14px; box-shadow: inset 0 1px 0 #fff, 0 1px 0 rgba(15,31,61,.03) }
  .section-header::before{ content:""; position:absolute; left:0; right:0; top:0; height:3px; background:#e5eaf1; border-top-left-radius:inherit; border-top-right-radius:inherit }

  /* Тёмно-синие МОНО-кружки (больше размер) */
  .section-title{ display:flex; align-items:center; gap:.6rem; font-size:1rem; font-weight:800; letter-spacing:.25px; color:var(--brand-700) }
  .section-title::before{ content:""; width:12px; height:12px; border-radius:50%; background:#0f1f3d }

  .section-arrow{ font-size:.95rem; color:#6b7280; transition: transform .2s ease, color .15s ease }
  .section-header:hover .section-arrow{ color:#dc2626 } /* красим стрелку в красный при hover */
  .section-arrow.expanded{ transform:rotate(180deg) }

  /* Плавное раскрытие */
  .section-content{ padding:0 .85rem .85rem; max-height:0; overflow:hidden; opacity:0; transition:max-height .35s ease, opacity .25s ease, padding-top .2s ease }
  .section-content.expanded{ padding:.85rem; max-height:1500px; opacity:1 }

  .algorithm-block{ margin-bottom:.9rem }
  .algorithm-block:last-child{ margin-bottom:0 }

  /* Кругляшок перед h4 — тёмно-синий моно, немного больше */
  .algorithm-block h4{ color:var(--brand-700); font-size:.95rem; font-weight:900; margin-bottom:.48rem; letter-spacing:.2px; display:flex; align-items:center; gap:.5rem }
  .algorithm-block h4::before{ content:""; width:10px; height:10px; border-radius:50%; background:#0f1f3d }

  .algorithm-block p{ font-size:.94rem; color:#3c465a; margin:.28rem 0 }
  .algorithm-block ul, .algorithm-block ol{ margin-left:1.15rem; margin-top:.3rem }
  .algorithm-block li{ margin:.28rem 0; color:#475569; font-size:.94rem }

  code{ background:#0b12200a; border:1px solid #e6ebf1; padding:.15rem .35rem; border-radius:8px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace }

  /* ======= Кнопки действий — упрощённые, без «дёрганий» ======= */
  .action-buttons{ display:flex; gap:.5rem; margin-top:.75rem; padding-top:.75rem; border-top:1px solid var(--border); flex-wrap:wrap }
  .action-btn{ padding:.42rem .68rem; border:1px solid #e5eaf1; border-radius:10px; cursor:pointer; font-size:.86rem; font-weight:500; letter-spacing:.2px; display:inline-flex; align-items:center; gap:.4rem; transition: background-color .15s ease, color .15s ease, border-color .15s ease }
  .action-btn:hover{ border-color:#d7deeb }
  .btn-primary{ background:#eef2ff; color:#0f1f3d }
  .btn-primary:hover{ background:#dbe7ff; color:#0b1730 }
  .btn-success{ background:#e8f7ec; color:#0f5132 }
  .btn-success:hover{ background:#d3f0db; color:#063b23 }
  .btn-secondary{ background:#f5f7fb; color:#374151 }
  .btn-secondary:hover{ background:#e9eef8; color:#111827 }

  /* Плавающая кнопка — только «Наверх» */
  .floating-buttons{ position:fixed; bottom:1.1rem; right:1.1rem; display:flex; flex-direction:column; gap:.55rem; z-index:1000 }
  .floating-btn{ background:linear-gradient(135deg, var(--brand), #1b2d59); color:#fff; border:none; padding:.8rem; border-radius:14px; width:50px; height:50px; cursor:pointer; box-shadow:var(--shadow-lg); transition: transform .08s ease, box-shadow .2s ease, filter .2s ease; font-size:.95rem; display:flex; align-items:center; justify-content:center }
  .floating-btn:hover{ transform:translateY(-2px); box-shadow:0 16px 40px rgba(15,31,61,.22); filter:saturate(1.05) }

  .highlight{ background:linear-gradient(180deg, rgba(59,130,246,.22), rgba(59,130,246,.12)); padding:1px 4px; border-radius:6px; box-decoration-break:clone }

  .no-results{ text-align:center; padding:2.2rem; color:#6b7280; font-size:1rem; position:relative }
  .no-results::before{ content:"🔎"; display:block; font-size:1.6rem; margin-bottom:.4rem; opacity:.85 }

  /* Модалка */
  .source-modal{ display:none; position:fixed; z-index:2000; inset:0; background:rgba(8,17,37,.6); backdrop-filter: blur(6px) }
  .modal-content{ background:var(--surface); margin:3% auto; padding:1.1rem 1.1rem 1.2rem; border-radius:18px; width:88%; max-width:980px; max-height:85vh; overflow-y:auto; position:relative; box-shadow: var(--shadow-lg); border:1px solid var(--border) }
  .modal-content h2{ font-size:1.12rem; margin-bottom:.8rem; color:var(--brand-700) }
  .close-modal{ position:absolute; top:.85rem; right:.85rem; font-size:1.3rem; cursor:pointer; color:#6b7280; line-height:1; padding:.2rem .4rem; border-radius:10px; transition:background .2s ease,color .2s ease }
  .close-modal:hover{ color:#1f2937; background:#f2f5f9 }

  /* Адаптив */
  @media (max-width: 900px){
    .header{ grid-template-columns: 1fr; row-gap:.75rem; align-items:stretch }
    .controls{ order:2 }
    .brand-title{ font-size:1.55rem }
    
    .title-right{ font-size:1.55rem }
  }
  @media (max-width: 768px){
    .section-header{ padding:.5rem .8rem }
    .section-title{ font-size:.95rem }
    .action-btn{ padding:.36rem .52rem; font-size:.82rem }
    .floating-btn{ width:46px; height:46px; font-size:.9rem; border-radius:12px }
  }

  /* Тёмная тема (авто) */
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1220; --text:#e5e7eb; --muted:#9aa3b2; --surface:#0e1424; --surface-2:#0b1220; --border:#16223a; --light-blue:#0f1f3d; --light-blue-2:#0e1424 }
    .section-card{ border-color:#16223a }
    .section-header{ background:linear-gradient(180deg,var(--light-blue-2),#0e1424); border-bottom-color:#16223a }
    .section-header::before{ background:#1f2a44 }
    .algorithm-block p, .algorithm-block li{ color:#cfd6df }
    code{ background:#0b1220; border-color:#16223a }
    .btn-secondary{ background:#131a2c; color:#cfd6df; border-color:#16223a }
    .modal-content{ border-color:#16223a }
  }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-bar">
  <span class="title-left">
    <span class="brand-title">Методика организации работы</span>
  </span>
  <span class="title-right">блока реализации и развития услуг</span>
</div>
    <div class="controls">
      <select id="reglamentSelect">
        <option value="r057-2022">Р 057-2022 - РЕГЛАМЕНТ ПО ВЫЯВЛЕНИЮ, СОКРАЩЕНИЮ И ИСКЛЮЧЕНИЮ БЕЗДОГОВОРНОГО И
БЕЗУЧЕТНОГО ПОТРЕБЛЕНИЯ ЭЛЕКТРОЭНЕРГИИ</option>
        <option value="other" disabled>Другие регламенты (будут добавлены)</option>
      </select>
      <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="Поиск по ключевым словам..." />
        <button id="clearSearch" aria-label="Очистить поиск">×</button>
      </div>
    </div>
  </div>

  <div class="container" id="contentContainer"></div>

  <div class="floating-buttons">
    <!-- Оставляем только кнопку Наверх -->
    <button class="floating-btn" id="scrollTopBtn" title="Наверх" style="display: none;">▲</button>
  </div>

  <div id="sourceModal" class="source-modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Исходный документ</h2>
      <div id="sourceText"></div>
    </div>
  </div>

  <script>
    // ======= Данные алгоритмов (как в исходнике) =======
    const algorithms = {
      'r057-2022': [
        { id: 'normative', title: 'НОРМАТИВНЫЕ ПОЛОЖЕНИЯ', content: { actions: [{ text: 'Изучить и применять в работе' }], responsible: 'Все сотрудники', deadline: 'Постоянно' } },
        { id: 'general', title: 'ОБЩИЕ ПОЛОЖЕНИЯ', content: { actions: [{ text: 'Знать основные понятия и определения бездоговорного/безучетного потребления' }], keyPoints: [ 'Договор считается заключенным с даты ТП или права собственности', 'Максимальный срок взыскания - 3 года', 'Потребление после расторжения договора = бездоговорное' ], responsible: 'Все сотрудники', deadline: 'Постоянно' } },
        { id: 'info-activities', title: 'ИНФОРМАЦИОННЫЕ МЕРОПРИЯТИЯ', content: { actions: [ { text: 'Проводить профилактику через:', list: [ 'Семинары и круглые столы', 'Работу с СМИ', 'Публикации на сайтах и соцсетях', 'Информационные стенды' ] } ], responsible: 'СРУ совместно с пресс-службой', deadline: 'По плану мероприятий' } },
        { id: 'parallel-connection', title: 'ЗАКЛЮЧЕНИЕ ДОГОВОРА ПАРАЛЛЕЛЬНО С ТП', content: { steps: [ 'Направить копии документов заявителя в ЭСК', 'Передать проект договора от ЭСК на УРРУ для подписания заявителем', 'После завершения ТП направить акты в ЭСК' ], deadlines: [ 'Передача документов в ЭСК - 2 раб. дня с даты договора ТП', 'Передача актов после ТП - 2 раб. дня' ], responsible: 'СРУ, УРРУ', control: 'Недопущение самовольного подключения' } },
        { id: 'no-contract-consumption', title: 'ОПРЕДЕЛЕНИЕ ПОТРЕБЛЕНИЯ БЕЗ ДОГОВОРА', content: { steps: [ 'Проверить наличие письменных договоров у всех потребителей', 'СРУ/УРРУ определяет объем потребления', 'Предъявить требования ГП по оплате услуг передачи' ], responsible: 'СРУ, УРРУ', deadline: 'Через 2 месяца после принятия ГП потребителей' } },
        { id: 'restriction-control', title: 'ВВЕДЕНИЕ ОГРАНИЧЕНИЯ И КОНТРОЛЬ', content: { steps: [ 'Вводить ограничение способом, максимально препятствующим подключению', 'Приоритет - отключение на опоре ВЛ', 'Составить акт с фотофиксацией', 'При повторном выявлении - усилить технические меры (защитные кожухи, демонтаж оборудования, замена на СИП)' ], responsible: 'РЭС', deadline: 'По заявкам на ограничение', control: 'По графику проверок' } },
        { id: 'planning-detection', title: 'ПЛАНИРОВАНИЕ ВЫЯВЛЕНИЯ НЕУЧТЕННОГО ПОТРЕБЛЕНИЯ', content: { actions: [ { text: 'Действия УРРУ:', list: [ 'Ежемесячный пофидерный анализ потерь', 'Формирование группы риска потребителей', 'Планирование рейдов' ] } ], riskCriteria: [ 'Несоответствие потребления оборудованию', 'Необоснованный недопуск', 'Ранее уличенные в хищении', 'Потребители с введенным ограничением' ], responsible: 'УРРУ под контролем СРУ', deadline: 'Ежемесячно', raids: 'Минимум 1 раз в месяц в каждом РЭС' } },
        { id: 'consumption-analysis', title: 'АНАЛИЗ ТЕКУЩЕГО ЭЛЕКТРОПОТРЕБЛЕНИЯ', content: { steps: [ 'Анализ динамики потребления за предыдущие периоды', 'Расчет среднестатистического потребления по типам', 'Выбор фидеров с максимальными потерями (в относительных и абсолютных единицах)' ], responsible: 'УРРУ', deadline: 'Перед каждым рейдом' } },
        { id: 'check-preparation', title: 'ПОДГОТОВКА К ПРОВЕРКАМ', content: { sources: [ 'Данные от ГП/ЭСК (п.123, 125 ПП РФ №442)', 'Обращения граждан (в т.ч. анонимные)', 'Визуальное обнаружение', 'Анализ потерь', 'Данные о введенных ограничениях', 'Анализ заявок на ТП' ], actions: [ { text: 'Проверить полученную информацию' } ], responsible: 'ФЭС, УРРУ', deadline: 'В течение 1 рабочего дня с момента получения' } },
        { id: 'conducting-checks', title: 'ПРОВЕДЕНИЕ ПРОВЕРОК', content: { steps: [ 'Представиться, предъявить удостоверение', 'Разъяснить цель проверки', 'Произвести фото/видеофиксацию с датой и временем', 'Составить акт о неучтенном потреблении', 'Получить объяснения потребителя', 'Вручить копию акта' ], nonAdmission: [ 'Составить акт недопуска с двумя свидетелями' ], consultations: 'При мощности >150 кВт или объеме >5000 кВтч - консультация СПСДФ в телефонном режиме', responsible: 'Персонал РЭС/УРРУ', deadline: 'На месте проверки' } },
        { id: 'calculation-unaccounted', title: 'РАСЧЕТ БЕЗУЧЕТНОГО ПОТРЕБЛЕНИЯ (ЮРЛИЦА)', content: { period: 'От предыдущей проверки до выявления, максимум 4380 часов (6 месяцев)', formulas: [ { title: 'При наличии Pmax:', formula: 'W = Pmax × T × 1,5' }, { title: 'При отсутствии Pmax:', list: [ 'Однофазный: W = (Iдоп × Uф × cosφ × T) / 1000', 'Трехфазный: W = (√3 × Iдоп × Uф × cosφ × T) / 1000' ] } ], parameters: [ 'cosφ = 0,9 (при отсутствии данных)', 'Iдоп - по характеристикам кабеля', 'Uф = 0,22 кВ' ], correction: 'Вычесть ранее предъявленное к оплате', responsible: 'Назначенное лицо СУЭ/СРУ/УРРУ', deadline: '2 рабочих дня с даты акта' } },
        { id: 'calculation-unaccounted-phys', title: 'РАСЧЕТ БЕЗУЧЕТНОГО ПОТРЕБЛЕНИЯ (ФИЗЛИЦА)', content: { unauthorizedConnection: [ 'Период: до 3 месяцев до даты выявления', 'Расчет: по нормативу × 10' ], meterIntervention: [ 'Период: с даты установки пломб, но не более 3 месяцев', 'Расчет: норматив × количество человек × 10' ], correction: [ 'Вычесть ранее оплаченное (кроме случаев потребления мимо ПУ)', 'Уменьшение периода при документальном подтверждении отсутствия' ], responsible: 'Назначенное лицо СУЭ/СРУ/УРРУ', deadline: '2 рабочих дня с даты акта' } },
        { id: 'contractless-calculation', title: 'РАСЧЕТ БЕЗДОГОВОРНОГО ПОТРЕБЛЕНИЯ', content: { period: [ 'Максимум 8760 часов (1 год)', 'От предыдущей проверки до выявления', 'При самовольном подключении - от предыдущей проверки ВЛ', 'При повторном подключении - от даты введения ограничения' ], formulas: [ { title: 'Формулы:', list: [ 'Однофазный: W = (Iдоп × Uф × cosφ × Tбд) / 1000', 'Трехфазный: W = (√3 × Iдоп × Uф × cosφ × Tбд) / 1000' ] } ], pricing: [ 'Население - по тарифам ДГРТ КК', 'Прочие - цена потерь + тариф на передачу' ], important: 'НЕ включается в объем оказанных услуг', responsible: 'СРУ, УРРУ', deadline: '2 рабочих дня с даты акта' } },
        { id: 'meter-malfunction', title: 'ДЕЙСТВИЯ ПРИ НЕИСПРАВНОСТИ ПРИБОРОВ УЧЕТА', content: { steps: [ 'Составить акт проверки по п.173 ПП №442', 'Обязательно использовать фото/видеофиксацию', 'Сделать перерасчет' ], recalculation: [ 'По показаниям за аналогичный период прошлого года', 'При отсутствии - за ближайший период с показаниями', 'Для ИСУЭ - за последние 3 расчетных периода' ], responsible: 'СУЭ', deadline: 'В момент проверки' } },
        { id: 'commission-review', title: 'КОМИССИОННОЕ РАССМОТРЕНИЕ АКТОВ', content: { structure: [ 'Комиссия УРРУ - первичное рассмотрение', 'Комиссия ФЭС - спорные вопросы и окончательные решения' ], composition: [ 'Минимум 3 человека', 'В комиссию ФЭС входят: зам. директора по РРУ, представитель СПСДФ, представитель безопасности' ], tasks: [ 'Проверка обоснованности и корректности актов', 'Утверждение расчетов', 'Передача актов в ЭСК/СПСДФ или на списание' ], timing: [ 'Комиссия УРРУ - постоянно', 'Комиссия ФЭС - по необходимости', 'Передача в ЭСК - 3 рабочих дня с даты составления' ], documents: 'Все решения оформляются протоколом', responsible: 'Председатели комиссий', deadline: 'См. выше' } },
        { id: 'damage-compensation', title: 'ВОЗМЕЩЕНИЕ УЩЕРБА ОТ БЕЗУЧЕТНОГО ПОТРЕБЛЕНИЯ', content: { steps: [ 'РСК передает акт с расчетом в ЭСК', 'ЭСК включает в объем услуг и выставляет счет потребителю', 'При неоплате - ЭСК ведет претензионную работу', 'РСК участвует как 3-е лицо в суде' ], deadlines: [ 'Передача в ЭСК - 3 рабочих дня', 'Реестр от ЭСК - ежемесячно' ], responsible: 'СРУ → ЭСК', deadline: 'См. выше' } },
        { id: 'calculation-unaccounted-dup', title: 'РАСЧЕТ БЕЗУЧЕТНОГО ПОТРЕБЛЕНИЯ (ЮРЛИЦА)', content: { period: 'От предыдущей проверки до выявления, максимум 4380 часов (6 месяцев)', formulas: [ { title: 'При наличии Pmax:', formula: 'W = Pmax × T × 1,5' }, { title: 'При отсутствии Pmax:', list: [ 'Однофазный: W = (Iдоп × Uф × cosφ × T) / 1000', 'Трехфазный: W = (√3 × Iдоп × Uф × cosφ × T) / 1000' ] } ], parameters: [ 'cosφ = 0,9 (при отсутствии данных)', 'Iдоп - по характеристикам кабеля', 'Uф = 0,22 кВ' ], correction: 'Вычесть ранее предъявленное к оплате', responsible: 'Назначенное лицо СУЭ/СРУ/УРРУ', deadline: '2 рабочих дня с даты акта' } },
        { id: 'cost-recovery', title: 'ВЗЫСКАНИЕ СТОИМОСТИ БЕЗДОГОВОРНОГО ПОТРЕБЛЕНИЯ', content: { steps: [ 'Расчет стоимости (без НДС)', 'Передача в бухгалтерию для выставления счета', 'Вручение счета лицу' ], nonPayment: [ 'Передача в СПСДФ через 10 дней после срока оплаты', 'СПСДФ направляет претензию - 5 рабочих дней', 'При отказе - иск в суд в течение 3 месяцев' ], documents: [ 'Оригинал акта и расчета', 'Документы о периоде расчета', 'Фото/видеоматериалы', 'Подтверждение направления счета' ], responsible: 'СРУ → Бухгалтерия → СПСДФ', deadline: 'См. выше' } },
        { id: 'law-enforcement', title: 'ЗАЯВЛЕНИЯ В ПРАВООХРАНИТЕЛЬНЫЕ ОРГАНЫ', content: { timing: [ 'Передать копию акта в подразделение безопасности - 4 рабочих дня', 'Безопасность готовит и направляет заявление - 3 рабочих дня' ], forms: [ 'Физлица - Приложение 13', 'Юрлица/ИП - Приложение 14', 'Сумма >250 тыс. руб. - Приложение 14.1', 'После введения ограничения - Приложение 14.2', 'При мощности >150 кВт - Приложение 14.3' ], special: 'При сумме >250 тыс. - направить в департамент безопасности ИА', responsible: 'Подразделение безопасности', deadline: '7 рабочих дней с даты составления акта' } },
        { id: 'operational-control', title: 'ОПЕРАТИВНЫЙ КОНТРОЛЬ', content: { steps: [ 'Внести все акты в ПК "1С:Энергетика"', 'Формировать отчеты (приложения 9-12) в Excel', 'Сверять данные с реестрами ЭСК', 'Вести журналы учета актов' ], reporting: [ 'Формат: Excel + скан с подписями', 'Направление: в УРУ департамента РУиУЭ ИА' ], storage: [ 'Журналы и отчеты - 5 лет', 'Акты и скан-копии - 5 лет или до полной оплаты' ], responsible: 'СРУ, руководители РЭС', deadline: 'До 18 числа месяца, следующего за отчетным' } }
      ]
    };

    let expandedSections = new Set();

    // ======= Нормализация строк для поиска =======
    function normalizeStr(s){
      return String(s)
        .toLowerCase()
        .replace(/ё/g,'е')
        .replace(/[\s._(),\-–—\[\]{}:;!?"'`~+/\\]+/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }

    // ======= Поиск по объекту =======
    function searchInObject(obj, termNorm){
      for (let key in obj){
        if (!Object.prototype.hasOwnProperty.call(obj, key)) continue;
        const value = obj[key];
        if (typeof value === 'string'){
          if (normalizeStr(value).includes(termNorm)) return true;
        } else if (Array.isArray(value)){
          for (let item of value){
            if (typeof item === 'string') { if (normalizeStr(item).includes(termNorm)) return true; }
            else if (item && typeof item === 'object' && searchInObject(item, termNorm)) return true;
          }
        } else if (value && typeof value === 'object'){
          if (searchInObject(value, termNorm)) return true;
        }
      }
      return false;
    }

    // ======= Экранирование и подсветка =======
    function escapeRegExp(str){ return String(str).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') }
    function highlightText(text, searchTerm){
      if (!searchTerm || text == null || typeof text !== 'string') return text;
      const pattern = escapeRegExp(searchTerm);
      if (!pattern) return text;
      const regex = new RegExp(`(${pattern})`, 'giu');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function renderContent(){
      const container = document.getElementById('contentContainer');
      const selectedReglament = document.getElementById('reglamentSelect').value;
      const rawInput = document.getElementById('searchInput').value || '';
      const normTerm = normalizeStr(rawInput);
      const rawTerm = rawInput.trim();

      // показать/скрыть крестик
      const clearBtn = document.getElementById('clearSearch');
      clearBtn.style.display = rawTerm ? 'block' : 'none';

      container.innerHTML = '';
      if (!algorithms[selectedReglament]){ container.innerHTML = '<div class="no-results">Регламент не найден</div>'; return; }

      let list = algorithms[selectedReglament];
      if (normTerm){ list = list.filter(algo => searchInObject(algo, normTerm)); }
      if (list.length === 0){ container.innerHTML = '<div class="no-results">По вашему запросу ничего не найдено</div>'; return; }

      list.forEach(algo => container.appendChild(createSection(algo, rawTerm)));
    }

    function createSection(algo, rawTerm){
      const card = document.createElement('div'); card.className = 'section-card';

      const header = document.createElement('div'); header.className = 'section-header'; header.onclick = () => toggleSection(algo.id);

      const title = document.createElement('div'); title.className = 'section-title'; title.innerHTML = highlightText(algo.title, rawTerm);

      const arrow = document.createElement('div'); arrow.className = 'section-arrow'; arrow.innerHTML = '▼'; if (expandedSections.has(algo.id)) arrow.classList.add('expanded');

      header.appendChild(title); header.appendChild(arrow);

      const content = document.createElement('div'); content.className = 'section-content'; content.id = `content-${algo.id}`; if (expandedSections.has(algo.id)) content.classList.add('expanded');

      if (algo.content.steps) content.appendChild(createBlock('Порядок действий:', algo.content.steps, rawTerm, true));

      if (algo.content.actions){
        algo.content.actions.forEach(action => {
          const actionDiv = document.createElement('div'); actionDiv.className = 'algorithm-block';
          actionDiv.innerHTML = `<h4>${highlightText(action.text, rawTerm)}</h4>`;
          if (action.list){ const ul = document.createElement('ul'); action.list.forEach(item => { const li = document.createElement('li'); li.innerHTML = highlightText(item, rawTerm); ul.appendChild(li); }); actionDiv.appendChild(ul); }
          content.appendChild(actionDiv);
        });
      }

      if (algo.content.keyPoints) content.appendChild(createBlock('Ключевые моменты:', algo.content.keyPoints, rawTerm));
      if (algo.content.riskCriteria) content.appendChild(createBlock('Критерии группы риска:', algo.content.riskCriteria, rawTerm));
      if (algo.content.raids){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Рейды:</h4><p>${highlightText(algo.content.raids, rawTerm)}</p>`; content.appendChild(b); }
      if (algo.content.period){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Период расчета:</h4><p>${highlightText(algo.content.period, rawTerm)}</p>`; content.appendChild(b); }

      if (algo.content.formulas){
        algo.content.formulas.forEach(f => {
          const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>${f.title}</h4>`;
          if (f.formula) b.innerHTML += `<p><code>${f.formula}</code></p>`;
          if (f.list){ const ul = document.createElement('ul'); f.list.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<code>${item}</code>`; ul.appendChild(li); }); b.appendChild(ul); }
          content.appendChild(b);
        });
      }

      if (algo.content.parameters) content.appendChild(createBlock('Параметры:', algo.content.parameters, rawTerm));
      if (algo.content.sources) content.appendChild(createBlock('Источники информации:', algo.content.sources, rawTerm));
      if (algo.content.unauthorizedConnection) content.appendChild(createBlock('При несанкционированном подключении (п.62 ПП РФ №354):', algo.content.unauthorizedConnection, rawTerm));
      if (algo.content.meterIntervention) content.appendChild(createBlock('При вмешательстве в прибор учета (п.81(11) ПП РФ №354):', algo.content.meterIntervention, rawTerm));
      if (algo.content.nonAdmission) content.appendChild(createBlock('При недопуске:', algo.content.nonAdmission, rawTerm));
      if (algo.content.pricing) content.appendChild(createBlock('Стоимость:', algo.content.pricing, rawTerm));
      if (algo.content.important){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4 style=\"color:#b91c1c;\">Важно:</h4><p><strong>${highlightText(algo.content.important, rawTerm)}</strong></p>`; content.appendChild(b); }
      if (algo.content.recalculation) content.appendChild(createBlock('Перерасчет:', algo.content.recalculation, rawTerm));
      if (algo.content.composition) content.appendChild(createBlock('Состав:', algo.content.composition, rawTerm));
      if (algo.content.tasks) content.appendChild(createBlock('Задачи комиссии:', algo.content.tasks, rawTerm));
      if (algo.content.timing) content.appendChild(createBlock('Сроки:', algo.content.timing, rawTerm));
      if (algo.content.structure) content.appendChild(createBlock('Структура комиссий:', algo.content.structure, rawTerm));
      if (algo.content.consultations){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Консультации:</h4><p>${highlightText(algo.content.consultations, rawTerm)}</p>`; content.appendChild(b); }
      if (algo.content.documents && typeof algo.content.documents === 'string'){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Документы:</h4><p>${highlightText(algo.content.documents, rawTerm)}</p>`; content.appendChild(b); }
      if (algo.content.deadlines) content.appendChild(createBlock('Сроки:', algo.content.deadlines, rawTerm));
      if (algo.content.nonPayment) content.appendChild(createBlock('При неоплате:', algo.content.nonPayment, rawTerm));
      if (algo.content.documents && Array.isArray(algo.content.documents)) content.appendChild(createBlock('Документы для СПСДФ:', algo.content.documents, rawTerm));
      if (algo.content.forms) content.appendChild(createBlock('Формы заявлений:', algo.content.forms, rawTerm));
      if (algo.content.reporting) content.appendChild(createBlock('Отчетность:', algo.content.reporting, rawTerm));
      if (algo.content.storage) content.appendChild(createBlock('Хранение:', algo.content.storage, rawTerm));
      if (algo.content.special){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Особый порядок:</h4><p>${highlightText(algo.content.special, rawTerm)}</p>`; content.appendChild(b); }
      if (algo.content.correction){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Корректировка:</h4><p>${highlightText(algo.content.correction, rawTerm)}</p>`; content.appendChild(b); }
      if (algo.content.control){ const b = document.createElement('div'); b.className = 'algorithm-block'; b.innerHTML = `<h4>Контроль:</h4><p>${highlightText(algo.content.control, rawTerm)}</p>`; content.appendChild(b); }

      const footer = document.createElement('div'); footer.className = 'algorithm-block';
      if (algo.content.responsible) footer.innerHTML += `<p><strong>Ответственный:</strong> ${highlightText(algo.content.responsible, rawTerm)}</p>`;
      if (algo.content.deadline) footer.innerHTML += `<p><strong>Срок:</strong> ${highlightText(algo.content.deadline, rawTerm)}</p>`;
      if (footer.innerHTML) content.appendChild(footer);

      const buttons = document.createElement('div'); buttons.className = 'action-buttons';
      const attachBtn = document.createElement('button'); attachBtn.className = 'action-btn btn-success'; attachBtn.innerHTML = '📎 Загрузить'; attachBtn.onclick = () => alert('Функция загрузки приложений будет добавлена позже');
      const openBtn = document.createElement('button'); openBtn.className = 'action-btn btn-primary'; openBtn.innerHTML = '📄 Документ'; openBtn.onclick = () => openSourceDocument(algo.id);
      const collapseBtn = document.createElement('button'); collapseBtn.className = 'action-btn btn-secondary'; collapseBtn.innerHTML = '↥ Свернуть'; collapseBtn.onclick = () => toggleSection(algo.id);
      buttons.appendChild(attachBtn); buttons.appendChild(openBtn); buttons.appendChild(collapseBtn);
      content.appendChild(buttons);

      card.appendChild(header); card.appendChild(content); return card;
    }

    function createBlock(title, items, rawTerm, ordered=false){
      const block = document.createElement('div'); block.className = 'algorithm-block'; block.innerHTML = `<h4>${title}</h4>`;
      const list = ordered ? document.createElement('ol') : document.createElement('ul');
      items.forEach(item=>{ const li = document.createElement('li'); li.innerHTML = highlightText(item, rawTerm); list.appendChild(li); });
      block.appendChild(list); return block;
    }

    function toggleSection(sectionId){
      const content = document.getElementById(`content-${sectionId}`); const arrow = content.previousElementSibling.querySelector('.section-arrow');
      if (expandedSections.has(sectionId)){ expandedSections.delete(sectionId); content.classList.remove('expanded'); arrow.classList.remove('expanded'); }
      else { expandedSections.add(sectionId); content.classList.add('expanded'); arrow.classList.add('expanded'); }
    }

    function openSourceDocument(sectionId) {
      const selectedReglament = document.getElementById('reglamentSelect').value;
      const navMap = navigationMaps[selectedReglament];
      if (!navMap || !navMap.sections[sectionId]) { alert('Раздел не найден в навигационной карте'); return; }
      const page = navMap.sections[sectionId].page;
      const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
      const pdfUrl = `${baseUrl}${navMap.docUrl}#page=${page}`;
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      if (isMobile) {
        const modal = document.getElementById('sourceModal');
        const sourceText = document.getElementById('sourceText');
        sourceText.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <h3 style="color: #0f1f3d; margin-bottom: 1rem;">Раздел ${navMap.sections[sectionId].section || page}</h3>
                <p style="margin-bottom: 1.5rem;">Откройте документ и перейдите на страницу <strong>${page}</strong></p>
                <a href="${baseUrl}${navMap.docUrl}" class="action-btn btn-primary" style="display: inline-block; text-decoration: none; padding: 0.75rem 1.5rem;">Скачать PDF</a>
                <button onclick="window.open('${baseUrl}${navMap.docUrl}', '_blank')" class="action-btn btn-primary" style="margin-left: 1rem; padding: 0.75rem 1.5rem;">Открыть PDF</button>
            </div>
        `;
        modal.style.display = 'block';
      } else {
        window.open(pdfUrl, '_blank');
      }
    }

    // Listeners
    document.getElementById('reglamentSelect').addEventListener('change', renderContent);
    document.getElementById('searchInput').addEventListener('input', renderContent);
    document.getElementById('clearSearch').addEventListener('click', () => { const i = document.getElementById('searchInput'); i.value = ''; i.focus(); renderContent(); });
    document.getElementById('scrollTopBtn').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    document.querySelector('.close-modal').addEventListener('click', () => document.getElementById('sourceModal').style.display = 'none');
    window.addEventListener('click', (e) => { const m = document.getElementById('sourceModal'); if (e.target === m) m.style.display = 'none'; });
    window.addEventListener('scroll', () => { const b = document.getElementById('scrollTopBtn'); b.style.display = window.pageYOffset > 300 ? 'flex' : 'none'; });

    // ======= Тесты (console) =======
    function runSearchTests(){
      const t1 = algorithms['r057-2022'].some(a => searchInObject(a, normalizeStr('физ')));
      console.assert(t1, 'Поиск по "физ" должен находить раздел(ы).');
      const t2 = algorithms['r057-2022'].some(a => searchInObject(a, normalizeStr('рску')) || searchInObject(a, normalizeStr('рск')));
      console.assert(t2, 'Поиск по "РСК" должен находить упоминания.');
      const t3 = algorithms['r057-2022'].some(a => searchInObject(a, normalizeStr('ФИЗ')));
      console.assert(t3, 'Поиск по "ФИЗ" (в верхнем регистре) должен находить раздел(ы).');
    }

    renderContent();
    runSearchTests();
  </script>
</body>
</html>
